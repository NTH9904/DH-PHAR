<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DH Pharmacy</title>
    <link rel="stylesheet" href="../ad css/main.css">
    <link rel="stylesheet" href="../ad css/cards.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>üíä DH Pharmacy</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="admin-nav">
                <a href="dashboard.html" class="active">üìä Dashboard</a>
                <a href="products.html">üíä S·∫£n ph·∫©m</a>
                <a href="orders.html">üì¶ ƒê∆°n h√†ng</a>
                <a href="users.html">üë• Ng∆∞·ªùi d√πng</a>
                <a href="prescriptions.html">üìã ƒê∆°n thu·ªëc</a>
                <a href="/" class="logout">üö™ Tho√°t</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>Dashboard</h1>
                <div id="admin-user-info"></div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-info">
                        <h3>T·ªïng ƒë∆°n h√†ng</h3>
                        <p class="stat-value" id="total-orders">0</p>
                        <span class="stat-change">+12% so v·ªõi th√°ng tr∆∞·ªõc</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <h3>Doanh thu</h3>
                        <p class="stat-value" id="total-revenue">0ƒë</p>
                        <span class="stat-change">+8% so v·ªõi th√°ng tr∆∞·ªõc</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üíä</div>
                    <div class="stat-info">
                        <h3>S·∫£n ph·∫©m</h3>
                        <p class="stat-value" id="total-products">0</p>
                        <span class="stat-change">+5 s·∫£n ph·∫©m m·ªõi</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3>Kh√°ch h√†ng</h3>
                        <p class="stat-value" id="total-users">0</p>
                        <span class="stat-change">+15 ng∆∞·ªùi d√πng m·ªõi</span>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="dashboard-section">
                <h2>ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h2>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            <tr>
                                <td colspan="5" class="text-center">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Low Stock Products -->
            <div class="dashboard-section">
                <h2>S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng</h2>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>S·∫£n ph·∫©m</th>
                                <th>Danh m·ª•c</th>
                                <th>T·ªìn kho</th>
                                <th>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-products">
                            <tr>
                                <td colspan="4" class="text-center">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../ad js/api.js"></script>
    <script src="../ad js/dashboard.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n admin');
            window.location.href = '/pages/login.html';
        }

        // Display user info
        document.getElementById('admin-user-info').innerHTML = `
            <div style="text-align: right;">
                <strong>${user.name || 'Admin'}</strong><br>
                <small>${user.email || ''}</small>
            </div>
        `;

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics
                const [productsRes, ordersRes, usersRes] = await Promise.all([
                    fetch('/api/products?limit=1', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/orders/admin/all?limit=1', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/users/admin/all?limit=1', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).catch(() => ({ json: () => ({ total: 0 }) }))
                ]);

                const products = await productsRes.json();
                const orders = await ordersRes.json();
                const users = await usersRes.json();

                document.getElementById('total-products').textContent = products.total || 0;
                document.getElementById('total-orders').textContent = orders.total || 0;
                document.getElementById('total-users').textContent = users.total || 0;

                // Calculate revenue
                if (orders.data && orders.data.length > 0) {
                    const revenue = orders.data.reduce((sum, order) => sum + (order.total || 0), 0);
                    document.getElementById('total-revenue').textContent = formatCurrency(revenue);
                }

                // Load recent orders
                loadRecentOrders();
                
                // Load low stock products
                loadLowStockProducts();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadRecentOrders() {
            try {
                const response = await fetch('/api/orders/admin/all?limit=5', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const orders = data.data || [];

                const tbody = document.getElementById('recent-orders');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td><strong>${order.orderNumber || order._id}</strong></td>
                        <td>${order.user?.name || 'N/A'}</td>
                        <td><strong>${formatCurrency(order.total)}</strong></td>
                        <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusLabel(order.status)}</span></td>
                        <td>${formatDate(order.createdAt)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading recent orders:', error);
                document.getElementById('recent-orders').innerHTML = 
                    '<tr><td colspan="5" class="text-center">Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng</td></tr>';
            }
        }

        async function loadLowStockProducts() {
            try {
                const response = await fetch('/api/products?limit=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const products = (data.data || []).filter(p => p.stock < 20).slice(0, 5);

                const tbody = document.getElementById('low-stock-products');
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">T·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu ƒë·ªß h√†ng</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.category}</td>
                        <td><strong style="color: ${product.stock < 10 ? '#E74C3C' : '#F39C12'}">${product.stock}</strong></td>
                        <td><span class="badge badge-${product.stock < 10 ? 'danger' : 'warning'}">
                            ${product.stock < 10 ? 'R·∫•t th·∫•p' : 'Th·∫•p'}
                        </span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading low stock products:', error);
                document.getElementById('low-stock-products').innerHTML = 
                    '<tr><td colspan="4" class="text-center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'shipping': 'ƒêang giao',
                'delivered': 'ƒê√£ giao',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return labels[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'confirmed': 'info',
                'processing': 'info',
                'shipping': 'info',
                'delivered': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        // Initialize
        loadDashboardData();
    </script>
</body>
</html>
