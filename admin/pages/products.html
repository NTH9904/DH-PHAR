<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m - Admin DH Pharmacy</title>
    <link rel="stylesheet" href="/admin/ad%20css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>üíä DH Pharmacy</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="admin-nav">
                <a href="dashboard.html">üìä Dashboard</a>
                <a href="products.html" class="active">üíä S·∫£n ph·∫©m</a>
                <a href="orders.html">üì¶ ƒê∆°n h√†ng</a>
                <a href="users.html">üë• Ng∆∞·ªùi d√πng</a>
                <a href="prescriptions.html">üìã ƒê∆°n thu·ªëc</a>
                <a href="inventory.html">üì¶ Kho h√†ng</a>
                <a href="suppliers.html">üè¢ Nh√† cung c·∫•p</a>
                <a href="promotions.html">üéÅ Khuy·∫øn m√£i</a>
                <a href="reports.html">üìä B√°o c√°o</a>
                <a href="/pages/index.html" class="home-link">üè† Trang ch·ªß</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                <button class="btn btn-primary" onclick="openProductModal()">
                    ‚ûï Th√™m s·∫£n ph·∫©m m·ªõi
                </button>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <div class="filters-row">
                    <input type="text" id="search-input" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="search-input">
                    <select id="category-filter" class="filter-select">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                    <select id="type-filter" class="filter-select">
                        <option value="">T·∫•t c·∫£ lo·∫°i</option>
                        <option value="prescription">Thu·ªëc k√™ ƒë∆°n</option>
                        <option value="otc">Thu·ªëc kh√¥ng k√™ ƒë∆°n</option>
                        <option value="supplement">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                    </select>
                    <select id="stock-filter" class="filter-select">
                        <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                        <option value="in-stock">C√≤n h√†ng</option>
                        <option value="low-stock">S·∫Øp h·∫øt</option>
                        <option value="out-of-stock">H·∫øt h√†ng</option>
                    </select>
                </div>
            </div>

            <!-- Products Table -->
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>H√¨nh ·∫£nh</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Danh m·ª•c</th>
                            <th>Lo·∫°i</th>
                            <th>Gi√°</th>
                            <th>T·ªìn kho</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <tr>
                            <td colspan="8" class="text-center">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">
                    Hi·ªÉn th·ªã <span id="showing-from">0</span> - <span id="showing-to">0</span> 
                    trong t·ªïng s·ªë <span id="total-products">0</span> s·∫£n ph·∫©m
                </div>
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be generated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="product-form" class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-name">T√™n s·∫£n ph·∫©m *</label>
                        <input type="text" id="product-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-generic-name">Th√†nh ph·∫ßn *</label>
                        <input type="text" id="product-generic-name" name="genericName" required placeholder="Paracetamol 500mg, Caffeine 30mg...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-category">Danh m·ª•c *</label>
                        <select id="product-category" name="category" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-type">Lo·∫°i thu·ªëc *</label>
                        <select id="product-type" name="type" required>
                            <option value="">Ch·ªçn lo·∫°i</option>
                            <option value="prescription">Thu·ªëc k√™ ƒë∆°n</option>
                            <option value="otc">Thu·ªëc kh√¥ng k√™ ƒë∆°n</option>
                            <option value="supplement">Th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-price">Gi√° b√°n (VNƒê) *</label>
                        <input type="number" id="product-price" name="price" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock">S·ªë l∆∞·ª£ng t·ªìn kho *</label>
                        <input type="number" id="product-stock" name="stock" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-brand">Th∆∞∆°ng hi·ªáu</label>
                        <input type="text" id="product-brand" name="brand">
                    </div>
                    <div class="form-group">
                        <label for="product-manufacturer">Nh√† s·∫£n xu·∫•t</label>
                        <input type="text" id="product-manufacturer" name="manufacturer">
                    </div>
                </div>

                <div class="form-group">
                    <label for="product-description">M√¥ t·∫£</label>
                    <textarea id="product-description" name="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="product-indications">C√¥ng d·ª•ng (m·ªói d√≤ng m·ªôt c√¥ng d·ª•ng)</label>
                    <textarea id="product-indications" name="indications" rows="3" placeholder="Gi·∫£m ƒëau&#10;H·∫° s·ªët&#10;Ch·ªëng vi√™m"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-dosage">Li·ªÅu d√πng</label>
                        <textarea id="product-dosage" name="dosage" rows="2" placeholder="Ng∆∞·ªùi l·ªõn: 1-2 vi√™n/l·∫ßn, 2-3 l·∫ßn/ng√†y"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="product-usage">C√°ch d√πng</label>
                        <textarea id="product-usage" name="usage" rows="2" placeholder="U·ªëng sau ƒÉn, ng·∫≠m d∆∞·ªõi l∆∞·ª°i, b√¥i ngo√†i da..."></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-package-size">Quy c√°ch ƒë√≥ng g√≥i</label>
                        <input type="text" id="product-package-size" name="packageSize" placeholder="H·ªôp 20 vi√™n">
                    </div>
                    <div class="form-group">
                        <label for="product-unit">ƒê∆°n v·ªã</label>
                        <select id="product-unit" name="unit">
                            <option value="vi√™n">Vi√™n</option>
                            <option value="chai">Chai</option>
                            <option value="h·ªôp">H·ªôp</option>
                            <option value="tu√Ωp">Tu√Ωp</option>
                            <option value="g√≥i">G√≥i</option>
                        </select>
                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="form-group">
                    <label>H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                    <div class="image-upload-container">
                        <div class="upload-methods">
                            <div class="upload-method">
                                <label class="upload-label">
                                    <input type="file" id="product-image-file" accept="image/*" style="display: none;" onchange="handleImageFileSelect(event)">
                                    <div class="upload-box">
                                        <span class="upload-icon">üì§</span>
                                        <span class="upload-text">Ch·ªçn file t·ª´ m√°y t√≠nh</span>
                                        <span class="upload-hint">JPG, PNG, GIF (Max 5MB)</span>
                                    </div>
                                </label>
                            </div>
                            <div class="upload-divider">HO·∫∂C</div>
                            <div class="upload-method">
                                <input type="text" id="product-image-url" placeholder="Nh·∫≠p URL h√¨nh ·∫£nh" class="form-control" onchange="handleImageUrlChange(event)">
                            </div>
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="image-preview" class="image-preview" style="display: none;">
                            <div class="preview-header">
                                <span>Xem tr∆∞·ªõc</span>
                                <button type="button" class="btn-remove-image" onclick="removeImage()">‚úï X√≥a</button>
                            </div>
                            <img id="preview-img" src="" alt="Preview">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="product-featured" name="isFeatured">
                        S·∫£n ph·∫©m n·ªïi b·∫≠t
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u s·∫£n ph·∫©m</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/admin/ad%20js/sidebar-toggle.js"></script>
    <script src="/admin/ad%20js/auto-refresh.js"></script>
    <script src="/admin/ad%20js/api.js"></script>
    <script src="/admin/ad%20js/products.js"></script>
    
    <script>
        // Image Upload Handlers
        let uploadedImageUrl = null;

        function handleImageFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh (JPG, PNG, GIF, WebP)');
                event.target.value = '';
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå File ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
                event.target.value = '';
                return;
            }

            // Show loading
            const uploadBox = event.target.closest('.upload-method').querySelector('.upload-box');
            const originalContent = uploadBox.innerHTML;
            uploadBox.innerHTML = '<div class="spinner" style="width: 30px; height: 30px; margin: 10px auto;"></div><span class="upload-text">ƒêang upload...</span>';

            // Upload file
            uploadImage(file)
                .then(url => {
                    uploadedImageUrl = url;
                    document.getElementById('product-image-url').value = url;
                    showImagePreview(url);
                    uploadBox.innerHTML = originalContent;
                })
                .catch(error => {
                    alert('‚ùå L·ªói khi upload ·∫£nh: ' + error.message);
                    uploadBox.innerHTML = originalContent;
                    event.target.value = '';
                });
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);

            const token = localStorage.getItem('token');
            const response = await fetch('/api/upload/product', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Upload failed');
            }

            const data = await response.json();
            return window.location.origin + data.data.url;
        }

        function handleImageUrlChange(event) {
            const url = event.target.value.trim();
            if (url) {
                uploadedImageUrl = url;
                showImagePreview(url);
            } else {
                hideImagePreview();
            }
        }

        function showImagePreview(url) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = url;
            img.onerror = function() {
                alert('‚ùå Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh t·ª´ URL n√†y');
                hideImagePreview();
            };
            preview.style.display = 'block';
        }

        function hideImagePreview() {
            const preview = document.getElementById('image-preview');
            preview.style.display = 'none';
            uploadedImageUrl = null;
        }

        function removeImage() {
            document.getElementById('product-image-file').value = '';
            document.getElementById('product-image-url').value = '';
            hideImagePreview();
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
            document.getElementById('product-form').reset();
            removeImage();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('product-modal');
            if (event.target === modal) {
                closeProductModal();
            }
        };
    </script>
</body>
</html>