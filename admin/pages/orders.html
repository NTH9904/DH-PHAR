<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Admin</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>üíä DH Pharmacy</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="admin-nav">
                <a href="dashboard.html">üìä Dashboard</a>
                <a href="products.html">üíä S·∫£n ph·∫©m</a>
                <a href="orders.html" class="active">üì¶ ƒê∆°n h√†ng</a>
                <a href="users.html">üë• Ng∆∞·ªùi d√πng</a>
                <a href="prescriptions.html">üìã ƒê∆°n thu·ªëc</a>
                <a href="/" class="logout">üö™ Tho√°t</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <input type="text" id="search-input" placeholder="T√¨m m√£ ƒë∆°n, kh√°ch h√†ng..." class="search-input">
                <select id="filter-status" class="filter-select">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="processing">ƒêang x·ª≠ l√Ω</option>
                    <option value="shipping">ƒêang giao</option>
                    <option value="delivered">ƒê√£ giao</option>
                    <option value="cancelled">ƒê√£ h·ªßy</option>
                </select>
            </div>

            <!-- Orders Table -->
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y ƒë·∫∑t</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        <tr>
                            <td colspan="7" class="text-center">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="order-detail">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            window.location.href = '/pages/login.html';
        }

        let currentPage = 1;

        async function loadOrders(page = 1) {
            try {
                const status = document.getElementById('filter-status').value;
                const search = document.getElementById('search-input').value;

                let url = `/api/orders/admin/all?page=${page}&limit=20`;
                if (status) url += `&status=${status}`;
                if (search) url += `&search=${search}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const orders = data.data || [];

                renderOrders(orders);
                renderPagination(data.page, data.pages);
                currentPage = page;
            } catch (error) {
                console.error('Error loading orders:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng');
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>${order.orderNumber || order._id.substring(0, 8)}</strong></td>
                    <td>${order.user?.name || 'N/A'}<br><small>${order.user?.email || ''}</small></td>
                    <td>${order.items?.length || 0} s·∫£n ph·∫©m</td>
                    <td><strong>${formatCurrency(order.total)}</strong></td>
                    <td>
                        <select onchange="updateOrderStatus('${order._id}', this.value)" class="status-select">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                            <option value="shipping" ${order.status === 'shipping' ? 'selected' : ''}>ƒêang giao</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>ƒê√£ giao</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                        </select>
                    </td>
                    <td>${formatDate(order.createdAt)}</td>
                    <td>
                        <button class="btn-icon" onclick="viewOrder('${order._id}')" title="Xem">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update status');

                showSuccess('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng');
            } catch (error) {
                console.error('Error updating status:', error);
                showError('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                loadOrders(currentPage);
            }
        }

        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const order = data.data;

                document.getElementById('order-detail').innerHTML = `
                    <div style="padding: 20px;">
                        <h3>ƒê∆°n h√†ng: ${order.orderNumber || order._id}</h3>
                        <p><strong>Kh√°ch h√†ng:</strong> ${order.user?.name || 'N/A'}</p>
                        <p><strong>Email:</strong> ${order.user?.email || 'N/A'}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${order.deliveryAddress?.phone || 'N/A'}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.deliveryAddress?.address || 'N/A'}</p>
                        <hr>
                        <h4>S·∫£n ph·∫©m:</h4>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>T√™n</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Gi√°</th>
                                    <th>T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)}</td>
                                        <td>${formatCurrency(item.subtotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <hr>
                        <p><strong>T·∫°m t√≠nh:</strong> ${formatCurrency(order.subtotal)}</p>
                        <p><strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong> ${formatCurrency(order.shippingFee)}</p>
                        <p><strong>Gi·∫£m gi√°:</strong> ${formatCurrency(order.discount || 0)}</p>
                        <h3><strong>T·ªïng c·ªông:</strong> ${formatCurrency(order.total)}</h3>
                    </div>
                `;

                document.getElementById('order-modal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading order:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
            }
        }

        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('vi-VN');
        }

        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        function renderPagination(current, total) {
            const container = document.getElementById('pagination');
            if (total <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= total; i++) {
                html += `<button class="btn ${i === current ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="loadOrders(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        document.getElementById('filter-status').addEventListener('change', () => loadOrders(1));
        document.getElementById('search-input').addEventListener('input', () => loadOrders(1));

        window.onclick = function(event) {
            const modal = document.getElementById('order-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        loadOrders(1);
    </script>
</body>
</html>
