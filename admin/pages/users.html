<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng - Admin</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>üíä DH Pharmacy</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="admin-nav">
                <a href="dashboard.html">üìä Dashboard</a>
                <a href="products.html">üíä S·∫£n ph·∫©m</a>
                <a href="orders.html">üì¶ ƒê∆°n h√†ng</a>
                <a href="users.html" class="active">üë• Ng∆∞·ªùi d√πng</a>
                <a href="prescriptions.html">üìã ƒê∆°n thu·ªëc</a>
                <a href="/" class="logout">üö™ Tho√°t</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <input type="text" id="search-input" placeholder="T√¨m t√™n, email..." class="search-input">
                <select id="filter-role" class="filter-select">
                    <option value="">T·∫•t c·∫£ vai tr√≤</option>
                    <option value="customer">Kh√°ch h√†ng</option>
                    <option value="pharmacist">D∆∞·ª£c sƒ©</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <!-- Users Table -->
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>T√™n</th>
                            <th>Email</th>
                            <th>ƒêi·ªán tho·∫°i</th>
                            <th>Vai tr√≤</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <tr>
                            <td colspan="7" class="text-center">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <script src="/js/api.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            window.location.href = '/pages/login.html';
        }

        let currentPage = 1;

        async function loadUsers(page = 1) {
            try {
                const role = document.getElementById('filter-role').value;
                const search = document.getElementById('search-input').value;

                // Note: This endpoint might not exist yet, using a workaround
                const response = await fetch(`/api/users?page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).catch(() => {
                    // Fallback: Load from seed data
                    return { json: () => ({ data: [], total: 0, page: 1, pages: 1 }) };
                });

                const data = await response.json ? await response.json() : { data: [], total: 0 };
                let users = data.data || [];

                // Filter by role if needed
                if (role) {
                    users = users.filter(u => u.role === role);
                }

                // Filter by search if needed
                if (search) {
                    const searchLower = search.toLowerCase();
                    users = users.filter(u => 
                        u.name?.toLowerCase().includes(searchLower) ||
                        u.email?.toLowerCase().includes(searchLower)
                    );
                }

                renderUsers(users);
                renderPagination(data.page || 1, data.pages || 1);
                currentPage = page;
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.name || 'N/A'}</strong></td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone || 'N/A'}</td>
                    <td><span class="badge badge-${getRoleBadge(user.role)}">${getRoleLabel(user.role)}</span></td>
                    <td><span class="badge badge-${user.isActive ? 'success' : 'danger'}">${user.isActive ? 'Ho·∫°t ƒë·ªông' : 'Kh√≥a'}</span></td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <button class="btn-icon" onclick="toggleUserStatus('${user._id}', ${!user.isActive})" title="${user.isActive ? 'Kh√≥a' : 'M·ªü kh√≥a'}">
                            ${user.isActive ? 'üîí' : 'üîì'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleUserStatus(userId, newStatus) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${newStatus ? 'm·ªü kh√≥a' : 'kh√≥a'} ng∆∞·ªùi d√πng n√†y?`)) return;

            try {
                // This endpoint might need to be created
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isActive: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update user');

                showSuccess('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng');
                loadUsers(currentPage);
            } catch (error) {
                console.error('Error updating user:', error);
                showError('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng');
            }
        }

        function getRoleLabel(role) {
            const labels = {
                'customer': 'Kh√°ch h√†ng',
                'pharmacist': 'D∆∞·ª£c sƒ©',
                'admin': 'Admin'
            };
            return labels[role] || role;
        }

        function getRoleBadge(role) {
            const badges = {
                'customer': 'info',
                'pharmacist': 'warning',
                'admin': 'danger'
            };
            return badges[role] || 'secondary';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        function renderPagination(current, total) {
            const container = document.getElementById('pagination');
            if (total <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= total; i++) {
                html += `<button class="btn ${i === current ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="loadUsers(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        document.getElementById('filter-role').addEventListener('change', () => loadUsers(1));
        document.getElementById('search-input').addEventListener('input', () => loadUsers(1));

        loadUsers(1);
    </script>
</body>
</html>
