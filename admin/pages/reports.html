<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o & Th·ªëng k√™ - Admin DH Pharmacy</title>
    <link rel="stylesheet" href="/admin/ad%20css/main.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js with multiple CDN fallbacks -->
    <script>
        // Try to load Chart.js from multiple CDNs
        function loadChartJS() {
            const cdns = [
                'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js'
            ];
            
            let currentCDN = 0;
            
            function tryLoadCDN() {
                if (currentCDN >= cdns.length) {
                    console.error('All Chart.js CDNs failed, using fallback');
                    window.Chart = null; // Set to null so we can detect it
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdns[currentCDN];
                script.onload = function() {
                    console.log('Chart.js loaded from:', cdns[currentCDN]);
                };
                script.onerror = function() {
                    console.warn('Failed to load Chart.js from:', cdns[currentCDN]);
                    currentCDN++;
                    tryLoadCDN();
                };
                document.head.appendChild(script);
            }
            
            tryLoadCDN();
        }
        
        loadChartJS();
    </script>
</head>
<body>
    <div class="admin-layout">
        <!-- Top Navigation -->
        <nav class="admin-topnav">
            <div class="topnav-left">
                <h1>üíä DH Pharmacy - Admin Panel</h1>
            </div>
            <div class="topnav-center">
                <a href="dashboard.html">üìä Dashboard</a>
                <a href="products.html">üíä S·∫£n ph·∫©m</a>
                <a href="orders.html">üì¶ ƒê∆°n h√†ng</a>
                <a href="users.html">üë• Ng∆∞·ªùi d√πng</a>
                <a href="prescriptions.html">üìã ƒê∆°n thu·ªëc</a>
                <a href="inventory.html">üì¶ Kho h√†ng</a>
                <a href="reports.html" class="active">üìä B√°o c√°o</a>
            </div>
            <div class="topnav-right">
                <a href="/pages/index.html" class="home-link">üè† Trang ch·ªß</a>
                <button class="btn btn-outline" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-content-full">
            <div class="admin-header">
                <h1>üìä B√°o c√°o & Th·ªëng k√™</h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="exportReport()">
                        üì• Xu·∫•t b√°o c√°o
                    </button>
                </div>
            </div>

            <!-- Time Range Filter -->
            <div class="filter-section">
                <div class="time-filter">
                    <label>Kho·∫£ng th·ªùi gian:</label>
                    <select id="timeRange" onchange="updateTimeRange()">
                        <option value="7">7 ng√†y qua</option>
                        <option value="30">30 ng√†y qua</option>
                        <option value="90">90 ng√†y qua</option>
                        <option value="custom">T√πy ch·ªçn</option>
                    </select>
                    
                    <div id="customDateRange" class="custom-date-range" style="display: none;">
                        <input type="date" id="startDate" />
                        <span>ƒë·∫øn</span>
                        <input type="date" id="endDate" />
                        <button class="btn btn-primary" onclick="applyCustomRange()">√Åp d·ª•ng</button>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card revenue">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-info">
                        <h3>T·ªïng doanh thu</h3>
                        <p class="metric-value" id="totalRevenue">0 ‚Ç´</p>
                        <span class="metric-change" id="revenueChange">+0%</span>
                    </div>
                </div>
                
                <div class="metric-card orders">
                    <div class="metric-icon">üì¶</div>
                    <div class="metric-info">
                        <h3>S·ªë ƒë∆°n h√†ng</h3>
                        <p class="metric-value" id="totalOrders">0</p>
                        <span class="metric-change" id="ordersChange">+0%</span>
                    </div>
                </div>
                
                <div class="metric-card customers">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-info">
                        <h3>Kh√°ch h√†ng m·ªõi</h3>
                        <p class="metric-value" id="newCustomers">0</p>
                        <span class="metric-change" id="customersChange">+0%</span>
                    </div>
                </div>
                
                <div class="metric-card avg-order">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-info">
                        <h3>Gi√° tr·ªã TB/ƒë∆°n</h3>
                        <p class="metric-value" id="avgOrderValue">0 ‚Ç´</p>
                        <span class="metric-change" id="avgChange">+0%</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üìà Doanh thu theo ng√†y</h3>
                        <div class="chart-controls">
                            <button class="btn btn-sm" onclick="toggleChartType('line')">ƒê∆∞·ªùng</button>
                            <button class="btn btn-sm" onclick="toggleChartType('bar')">C·ªôt</button>
                        </div>
                    </div>
                    <div style="position: relative; height: 400px;">
                        <canvas id="revenueChart"></canvas>
                        <div id="revenueChartLoading" class="chart-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üèÜ Top 10 s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                    </div>
                    <div style="position: relative; height: 400px;">
                        <canvas id="topProductsChart"></canvas>
                        <div id="topProductsChartLoading" class="chart-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Tables -->
            <div class="tables-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üìä Chi ti·∫øt doanh thu theo ng√†y</h3>
                        <button class="btn btn-outline btn-sm" onclick="exportDailyRevenue()">
                            üì• Xu·∫•t Excel
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="dailyRevenueTable">
                            <thead>
                                <tr>
                                    <th>Ng√†y</th>
                                    <th>S·ªë ƒë∆°n</th>
                                    <th>Doanh thu</th>
                                    <th>Kh√°ch h√†ng m·ªõi</th>
                                    <th>TƒÉng tr∆∞·ªüng</th>
                                </tr>
                            </thead>
                            <tbody id="dailyRevenueBody">
                                <tr>
                                    <td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>üèÜ Top s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                        <button class="btn btn-outline btn-sm" onclick="exportTopProducts()">
                            üì• Xu·∫•t Excel
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="topProductsTable">
                            <thead>
                                <tr>
                                    <th>H·∫°ng</th>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>ƒê√£ b√°n</th>
                                    <th>Doanh thu</th>
                                    <th>% T·ªïng DT</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsBody">
                                <tr>
                                    <td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...</p>
                </div>
            </div>
        </main>
    </div>

    <script src="/admin/ad%20js/common.js"></script>
    <script src="/admin/ad%20js/reports.js"></script>
</body>
</html>