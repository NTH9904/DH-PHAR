<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n - DH Pharmacy</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="container">
                <div>üìû Hotline: 0344864576 | üí¨ Zalo: 0344864576</div>
                <div>üöö Giao h√†ng nhanh 2-4 gi·ªù | ‚úÖ ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng</div>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <a href="/pages/index.html" class="logo">
                    <span>üíä</span>
                    <span>DH Pharmacy</span>
                </a>
                <div class="search-bar">
                    <form>
                        <div class="input-search">
                            <input type="text" placeholder="T√¨m ki·∫øm thu·ªëc, ho·∫°t ch·∫•t, tri·ªáu ch·ª©ng...">
                        </div>
                        <div class="submit-button">
                        </div>
                    </form>
                </div>
                <nav class="nav">
                    <a href="/pages/index.html" class="nav-link">Trang ch·ªß</a>
                    <a href="/pages/products.html" class="nav-link">S·∫£n ph·∫©m</a>
                    <a href="/pages/consultation.html" class="nav-link">T∆∞ v·∫•n</a>
                    <a href="/pages/about.html" class="nav-link">Gi·ªõi thi·ªáu</a>
                    <div class="cart-icon">
                        <a href="/pages/cart.html" class="nav-link">üõí Gi·ªè h√†ng</a>
                        <span class="cart-badge" style="display: none;">0</span>
                    </div>
                    <div class="user-menu">
                        <a href="/pages/login.html" class="nav-link">ƒêƒÉng nh·∫≠p</a>
                        <a href="/pages/register.html" class="nav-link">ƒêƒÉng k√Ω</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 style="margin-bottom: 30px;">Thanh to√°n</h1>

            <div id="checkout-content">
                <div class="text-center">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/cart.js"></script>
    <script src="/js/main.js"></script>
    <script>
        async function loadCheckout() {
            const container = document.getElementById('checkout-content');
            const token = window.API.getToken();

            if (!token) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <p>Vui l√≤ng <a href="/pages/login.html">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ thanh to√°n</p>
                    </div>
                `;
                return;
            }

            const cart = window.Cart.getCart();
            if (cart.items.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <p>Gi·ªè h√†ng tr·ªëng. <a href="/pages/products.html">Ti·∫øp t·ª•c mua s·∫Øm</a></p>
                    </div>
                `;
                return;
            }

            try {
                // Load user addresses
                const addressesResponse = await window.API.users.getAddresses();
                const addresses = addressesResponse.data || [];

                // Calculate totals
                let subtotal = 0;
                const items = [];
                for (const item of cart.items) {
                    const product = await window.API.products.getById(item.productId);
                    const productData = product.data;
                    const itemTotal = productData.price * item.quantity;
                    subtotal += itemTotal;
                    items.push({
                        productId: item.productId,
                        quantity: item.quantity,
                        name: productData.name,
                        price: productData.price
                    });
                }

                const shippingFee = subtotal >= 500000 ? 0 : 30000;
                const total = subtotal + shippingFee;

                container.innerHTML = `
                    <form id="checkout-form" onsubmit="submitOrder(event)">
                        <div class="grid grid-2" style="gap: 24px;">
                            <div>
                                <div class="card" style="margin-bottom: 24px;">
                                    <div class="card-header">
                                        <h3>ƒê·ªãa ch·ªâ giao h√†ng</h3>
                                    </div>
                                    <div class="card-body">
                                        ${addresses.length > 0 ? `
                                            <div class="form-group">
                                                <label class="form-label">Ch·ªçn ƒë·ªãa ch·ªâ:</label>
                                                <select class="form-control" id="address-select" onchange="selectAddress()">
                                                    <option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>
                                                    ${addresses.map((addr, index) => `
                                                        <option value="${index}" ${addr.isDefault ? 'selected' : ''}>
                                                            ${addr.name} - ${addr.address}, ${addr.ward}, ${addr.district}, ${addr.city}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-outline" onclick="showNewAddressForm()">Th√™m ƒë·ªãa ch·ªâ m·ªõi</button>
                                        ` : ''}
                                        
                                        <div id="address-form" ${addresses.length > 0 ? 'style="display: none;"' : ''}>
                                            <div class="form-group">
                                                <label class="form-label">H·ªç t√™n *</label>
                                                <input type="text" class="form-control" id="name" required>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                                                <input type="tel" class="form-control" id="phone" required>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">ƒê·ªãa ch·ªâ *</label>
                                                <input type="text" class="form-control" id="address" required>
                                            </div>
                                            <div class="grid grid-3" style="gap: 16px;">
                                                <div class="form-group">
                                                    <label class="form-label">Ph∆∞·ªùng/X√£ *</label>
                                                    <input type="text" class="form-control" id="ward" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Qu·∫≠n/Huy·ªán *</label>
                                                    <input type="text" class="form-control" id="district" required>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Th√†nh ph·ªë *</label>
                                                    <input type="text" class="form-control" id="city" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card" style="margin-bottom: 24px;">
                                    <div class="card-header">
                                        <h3>Th·ªùi gian giao h√†ng</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label class="form-label">Ng√†y giao h√†ng *</label>
                                            <input type="date" class="form-control" id="delivery-date" required min="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Khung gi·ªù *</label>
                                            <select class="form-control" id="delivery-time" required>
                                                <option value="morning">S√°ng (8:00 - 12:00)</option>
                                                <option value="afternoon">Chi·ªÅu (13:00 - 17:00)</option>
                                                <option value="evening">T·ªëi (18:00 - 21:00)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label>
                                                <input type="radio" name="payment-method" value="cod" checked>
                                                Thanh to√°n khi nh·∫≠n h√†ng (COD)
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="radio" name="payment-method" value="bank_transfer">
                                                Chuy·ªÉn kho·∫£n ng√¢n h√†ng
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="radio" name="payment-method" value="vnpay">
                                                VNPay
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="radio" name="payment-method" value="momo">
                                                MoMo
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="card" style="margin-top: 24px;">
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                                            <textarea class="form-control" id="notes" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="card" style="position: sticky; top: 100px;">
                                    <div class="card-header">
                                        <h3>ƒê∆°n h√†ng</h3>
                                    </div>
                                    <div class="card-body">
                                        <div id="order-items">
                                            ${items.map(item => `
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                                    <div>
                                                        <div>${item.name}</div>
                                                        <div style="font-size: 14px; color: var(--text-light);">x${item.quantity}</div>
                                                    </div>
                                                    <div>${window.utils?.formatCurrency(item.price * item.quantity) || (item.price * item.quantity).toLocaleString('vi-VN') + ' ƒë'}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <hr style="margin: 24px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>T·∫°m t√≠nh:</span>
                                            <span>${window.utils?.formatCurrency(subtotal) || subtotal.toLocaleString('vi-VN') + ' ƒë'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                            <span>${shippingFee === 0 ? 'Mi·ªÖn ph√≠' : window.utils?.formatCurrency(shippingFee) || shippingFee.toLocaleString('vi-VN') + ' ƒë'}</span>
                                        </div>
                                        <hr style="margin: 24px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 24px;">
                                            <strong style="font-size: 18px;">T·ªïng c·ªông:</strong>
                                            <strong style="font-size: 20px; color: var(--primary-color);">
                                                ${window.utils?.formatCurrency(total) || total.toLocaleString('vi-VN') + ' ƒë'}
                                            </strong>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                                            ƒê·∫∑t h√†ng
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                `;
            } catch (error) {
                console.error('Error loading checkout:', error);
                container.innerHTML = '<p class="text-center text-error">Kh√¥ng th·ªÉ t·∫£i trang thanh to√°n</p>';
            }
        }

        function selectAddress() {
            const select = document.getElementById('address-select');
            if (select.value === '') {
                showNewAddressForm();
            } else {
                document.getElementById('address-form').style.display = 'none';
            }
        }

        function showNewAddressForm() {
            document.getElementById('address-form').style.display = 'block';
            document.getElementById('address-select').value = '';
        }

        async function submitOrder(e) {
            e.preventDefault();
            
            const form = document.getElementById('checkout-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                const cart = window.Cart.getCart();
                const items = cart.items.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                }));

                const addressSelect = document.getElementById('address-select');
                let deliveryAddress;

                if (addressSelect && addressSelect.value !== '') {
                    // Use selected address
                    const addressesResponse = await window.API.users.getAddresses();
                    const addresses = addressesResponse.data || [];
                    deliveryAddress = addresses[parseInt(addressSelect.value)];
                } else {
                    // Use form data
                    deliveryAddress = {
                        name: document.getElementById('name').value,
                        phone: document.getElementById('phone').value,
                        address: document.getElementById('address').value,
                        ward: document.getElementById('ward').value,
                        district: document.getElementById('district').value,
                        city: document.getElementById('city').value
                    };
                }

                const orderData = {
                    items,
                    deliveryAddress,
                    deliveryTime: {
                        preferredDate: document.getElementById('delivery-date').value,
                        preferredTimeSlot: document.getElementById('delivery-time').value
                    },
                    paymentMethod: document.querySelector('input[name="payment-method"]:checked').value,
                    customerNotes: document.getElementById('notes').value
                };

                const response = await window.API.orders.create(orderData);
                
                // Clear cart
                window.Cart.clearCart();
                
                // Redirect to order confirmation
                window.location.href = `/pages/orders.html?order=${response.data._id}`;
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'ƒê·∫∑t h√†ng';
            }
        }

        // Initialize
        loadCheckout();
    </script>
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>DH Pharmacy</h3>
                    <p>Nh√† thu·ªëc tr·ª±c tuy·∫øn uy t√≠n, giao h√†ng nhanh, t∆∞ v·∫•n chuy√™n nghi·ªáp.</p>
                    <p>Gi·∫•y ph√©p: S·ªë 12345/GP-BYT</p>
                </div>
                <div class="footer-section">
                    <h3>Li√™n h·ªá</h3>
                    <p>üìû Hotline: 0344864576</p>
                    <p>üí¨ Zalo: 0344864576</p>
                    <p>üìß Email: dhpharmacy@gmail.com</p>
                    <p>üìç ƒê·ªãa ch·ªâ: S·ªë 3 ƒê√¥ng Ng√†n - T·ª´ S∆°n - B·∫Øc Ninh</p>
                </div>
                <div class="footer-section">
                    <h3>H·ªó tr·ª£</h3>
                    <a href="/pages/about.html">Gi·ªõi thi·ªáu</a>
                    <a href="/pages/contact.html">Li√™n h·ªá</a>
                    <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                    <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                    <a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DH Pharmacy. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>

