<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i - DH Pharmacy</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="container">
                <div>üìû Hotline: 0344864576 | üí¨ Zalo: 0344864576</div>
                <div>üöö Giao h√†ng nhanh 2-4 gi·ªù | ‚úÖ ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng</div>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <a href="/pages/index.html" class="logo">
                    <span>üíä</span>
                    <span>DH Pharmacy</span>
                </a>
                <div class="search-bar">
                    <form>
                        <div class="input-search">
                            <input type="text" placeholder="T√¨m ki·∫øm thu·ªëc, ho·∫°t ch·∫•t, tri·ªáu ch·ª©ng...">
                        </div>
                        <div class="submit-button">
                        </div>
                    </form>
                </div>
                <nav class="nav">
                    <a href="/pages/index.html" class="nav-link">Trang ch·ªß</a>
                    <a href="/pages/products.html" class="nav-link">S·∫£n ph·∫©m</a>
                    <a href="/pages/consultation.html" class="nav-link">T∆∞ v·∫•n</a>
                    <a href="/pages/about.html" class="nav-link">Gi·ªõi thi·ªáu</a>
                    <div class="cart-icon">
                        <a href="/pages/cart.html" class="nav-link">üõí Gi·ªè h√†ng</a>
                        <span class="cart-badge" style="display: none;">0</span>
                    </div>
                    <div class="user-menu">
                        <a href="/pages/login.html" class="nav-link">ƒêƒÉng nh·∫≠p</a>
                        <a href="/pages/register.html" class="nav-link">ƒêƒÉng k√Ω</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 style="margin-bottom: 30px;">ƒê∆°n h√†ng c·ªßa t√¥i</h1>

            <div id="orders-content">
                <div class="text-center">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>DH Pharmacy</h3>
                    <p>Nh√† thu·ªëc tr·ª±c tuy·∫øn uy t√≠n, giao h√†ng nhanh, t∆∞ v·∫•n chuy√™n nghi·ªáp.</p>
                    <p>Gi·∫•y ph√©p: S·ªë 12345/GP-BYT</p>
                </div>
                <div class="footer-section">
                    <h3>Li√™n h·ªá</h3>
                    <p>üìû Hotline: 0344864576</p>
                    <p>üí¨ Zalo: 0344864576</p>
                    <p>üìß Email: dhpharmacy@gmail.com</p>
                    <p>üìç ƒê·ªãa ch·ªâ: S·ªë 3 ƒê√¥ng Ng√†n - T·ª´ S∆°n - B·∫Øc Ninh</p>
                </div>
                <div class="footer-section">
                    <h3>H·ªó tr·ª£</h3>
                    <a href="/pages/about.html">Gi·ªõi thi·ªáu</a>
                    <a href="/pages/contact.html">Li√™n h·ªá</a>
                    <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                    <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                    <a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DH Pharmacy. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>
    <script>
        const statusLabels = {
            'pending': 'Ch·ªù x√°c nh·∫≠n',
            'confirmed': 'ƒê√£ x√°c nh·∫≠n',
            'processing': 'ƒêang x·ª≠ l√Ω',
            'shipping': 'ƒêang giao h√†ng',
            'delivered': 'ƒê√£ giao h√†ng',
            'cancelled': 'ƒê√£ h·ªßy',
            'returned': 'ƒê√£ tr·∫£ h√†ng'
        };

        const statusColors = {
            'pending': 'warning',
            'confirmed': 'primary',
            'processing': 'primary',
            'shipping': 'primary',
            'delivered': 'success',
            'cancelled': 'danger',
            'returned': 'danger'
        };

        async function loadOrders() {
            const container = document.getElementById('orders-content');
            const orderId = new URLSearchParams(window.location.search).get('order');

            try {
                if (orderId) {
                    // Load single order
                    const response = await window.API.orders.getById(orderId);
                    const order = response.data;
                    container.innerHTML = renderOrderDetail(order);
                } else {
                    // Load all orders
                    const response = await window.API.orders.getMyOrders();
                    const orders = response.data || [];

                    if (orders.length === 0) {
                        container.innerHTML = `
                            <div class="text-center" style="padding: 60px 0;">
                                <div style="font-size: 64px; margin-bottom: 24px;">üì¶</div>
                                <h2>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h2>
                                <p style="margin-bottom: 24px;">B·∫Øt ƒë·∫ßu mua s·∫Øm ngay!</p>
                                <a href="/pages/products.html" class="btn btn-primary">Mua s·∫Øm ngay</a>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = orders.map(order => renderOrderCard(order)).join('');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/pages/login.html';
                } else {
                    container.innerHTML = '<p class="text-center text-error">Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng</p>';
                }
            }
        }

        function renderOrderCard(order) {
            return `
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <h3>ƒê∆°n h√†ng #${order.orderNumber}</h3>
                                <p style="color: var(--text-light); margin-top: 4px;">
                                    ${window.utils?.formatDate(order.createdAt) || new Date(order.createdAt).toLocaleDateString('vi-VN')}
                                </p>
                            </div>
                            <div>
                                <span class="badge badge-${statusColors[order.status] || 'primary'}">
                                    ${statusLabels[order.status] || order.status}
                                </span>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            ${order.items.map(item => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>${item.name} x${item.quantity}</span>
                                    <span>${window.utils?.formatCurrency(item.subtotal) || item.subtotal.toLocaleString('vi-VN') + ' ƒë'}</span>
                                </div>
                            `).join('')}
                        </div>
                        <hr style="margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>T·ªïng c·ªông: ${window.utils?.formatCurrency(order.total) || order.total.toLocaleString('vi-VN') + ' ƒë'}</strong>
                            </div>
                            <div>
                                <a href="/pages/orders.html?order=${order._id}" class="btn btn-outline">Xem chi ti·∫øt</a>
                                ${['pending', 'confirmed'].includes(order.status) ? `
                                    <button class="btn btn-outline" onclick="cancelOrder('${order._id}')" style="color: var(--error-color); margin-left: 8px;">H·ªßy ƒë∆°n</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOrderDetail(order) {
            return `
                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2>ƒê∆°n h√†ng #${order.orderNumber}</h2>
                            <span class="badge badge-${statusColors[order.status] || 'primary'}">
                                ${statusLabels[order.status] || order.status}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-2" style="gap: 24px; margin-bottom: 24px;">
                            <div>
                                <h3>Th√¥ng tin giao h√†ng</h3>
                                <p><strong>${order.deliveryAddress.name}</strong></p>
                                <p>${order.deliveryAddress.phone}</p>
                                <p>${order.deliveryAddress.address}, ${order.deliveryAddress.ward}, ${order.deliveryAddress.district}, ${order.deliveryAddress.city}</p>
                            </div>
                            <div>
                                <h3>Th√¥ng tin thanh to√°n</h3>
                                <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${order.paymentMethod === 'cod' ? 'Thanh to√°n khi nh·∫≠n h√†ng' : order.paymentMethod}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${order.paymentStatus === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}</p>
                            </div>
                        </div>

                        <h3 style="margin-bottom: 16px;">S·∫£n ph·∫©m</h3>
                        <table style="width: 100%; margin-bottom: 24px;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="text-align: left; padding: 12px 0;">S·∫£n ph·∫©m</th>
                                    <th style="text-align: right; padding: 12px 0;">S·ªë l∆∞·ª£ng</th>
                                    <th style="text-align: right; padding: 12px 0;">Gi√°</th>
                                    <th style="text-align: right; padding: 12px 0;">T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px 0;">${item.name}</td>
                                        <td style="text-align: right; padding: 12px 0;">${item.quantity}</td>
                                        <td style="text-align: right; padding: 12px 0;">${window.utils?.formatCurrency(item.price) || item.price.toLocaleString('vi-VN') + ' ƒë'}</td>
                                        <td style="text-align: right; padding: 12px 0;">${window.utils?.formatCurrency(item.subtotal) || item.subtotal.toLocaleString('vi-VN') + ' ƒë'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div style="text-align: right; margin-bottom: 24px;">
                            <p>T·∫°m t√≠nh: ${window.utils?.formatCurrency(order.subtotal) || order.subtotal.toLocaleString('vi-VN') + ' ƒë'}</p>
                            <p>Ph√≠ v·∫≠n chuy·ªÉn: ${window.utils?.formatCurrency(order.shippingFee) || order.shippingFee.toLocaleString('vi-VN') + ' ƒë'}</p>
                            ${order.discount > 0 ? `<p>Gi·∫£m gi√°: -${window.utils?.formatCurrency(order.discount) || order.discount.toLocaleString('vi-VN') + ' ƒë'}</p>` : ''}
                            <p><strong style="font-size: 18px;">T·ªïng c·ªông: ${window.utils?.formatCurrency(order.total) || order.total.toLocaleString('vi-VN') + ' ƒë'}</strong></p>
                        </div>

                        <div style="margin-top: 24px;">
                            <a href="/pages/orders.html" class="btn btn-outline">Quay l·∫°i danh s√°ch</a>
                            ${['pending', 'confirmed'].includes(order.status) ? `
                                <button class="btn btn-outline" onclick="cancelOrder('${order._id}')" style="color: var(--error-color); margin-left: 8px;">H·ªßy ƒë∆°n h√†ng</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function cancelOrder(orderId) {
            const reason = prompt('L√Ω do h·ªßy ƒë∆°n h√†ng:');
            if (!reason) return;

            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) {
                try {
                    await window.API.orders.cancel(orderId, reason);
                    alert('H·ªßy ƒë∆°n h√†ng th√†nh c√¥ng');
                    loadOrders();
                } catch (error) {
                    alert('H·ªßy ƒë∆°n h√†ng th·∫•t b·∫°i: ' + error.message);
                }
            }
        }

        // Initialize
        loadOrders();
    </script>
</body>
</html>

